pipeline {
    agent any

    environment {
        SITE_PATH = '/var/www/jaquesprojetos.com.br/html'
        BACKUP_PATH = '/var/backups/site'
        REPO_URL = 'https://github.com/SEU_USUARIO/SEU_REPOSITORIO.git'
    }

    stages {
        stage('Backup') {
            steps {
                script {
                    sh '''
                        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                        sudo mkdir -p ${BACKUP_PATH}
                        sudo tar -czf ${BACKUP_PATH}/backup_${TIMESTAMP}.tar.gz -C ${SITE_PATH} .

                        # Manter apenas os √∫ltimos 5 backups
                        cd ${BACKUP_PATH}
                        ls -t backup_*.tar.gz | tail -n +6 | xargs -r sudo rm
                    '''
                }
            }
        }

        stage('Clone') {
            steps {
                git branch: 'main', url: "${REPO_URL}"
            }
        }

        stage('Validar') {
            steps {
                sh '''
                    if [ ! -f "index.html" ]; then
                        echo "ERRO: index.html n√£o encontrado!"
                        exit 1
                    fi
                '''
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                    # Limpar arquivos antigos
                    sudo find ${SITE_PATH} -mindepth 1 -delete

                    # Copiar novos arquivos
                    sudo cp -r * ${SITE_PATH}/

                    # Ajustar permiss√µes
                    sudo chown -R www-data:www-data ${SITE_PATH}
                    sudo find ${SITE_PATH} -type d -exec chmod 755 {} \;
                    sudo find ${SITE_PATH} -type f -exec chmod 644 {} \;
                '''
            }
        }

        stage('Verificar') {
            steps {
                sh '''
                    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://jaquesprojetos.com.br)

                    if [ "$HTTP_CODE" != "200" ]; then
                        echo "ERRO: Site retornou c√≥digo $HTTP_CODE"
                        exit 1
                    fi

                    echo "‚úÖ Deploy verificado! C√≥digo: $HTTP_CODE"
                '''
            }
        }

        stage('Recarregar Nginx') {
            steps {
                sh 'sudo systemctl reload nginx'
            }
        }
    }

    post {
        success {
            echo '‚úÖ Deploy realizado com sucesso! üöÄ'
        }
        failure {
            echo '‚ùå Deploy falhou! Restaurando backup...'
            sh '''
                LAST_BACKUP=$(ls -t ${BACKUP_PATH}/backup_*.tar.gz | head -n 1)
                if [ -f "$LAST_BACKUP" ]; then
                    sudo tar -xzf $LAST_BACKUP -C ${SITE_PATH}
                    echo "Backup restaurado: $LAST_BACKUP"
                fi
            '''
        }
    }
}